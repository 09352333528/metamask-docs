"use strict";(self.webpackChunkmetamask_docs=self.webpackChunkmetamask_docs||[]).push([[82],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var a=t(67294);function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,s=function(e,n){if(null==e)return{};var t,a,s={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(s[t]=e[t]);return s}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var p=a.createContext({}),l=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},c=function(e){var n=l(e.components);return a.createElement(p.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,s=e.mdxType,i=e.originalType,p=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),u=l(t),h=s,m=u["".concat(p,".").concat(h)]||u[h]||d[h]||i;return t?a.createElement(m,r(r({ref:n},c),{},{components:t})):a.createElement(m,r({ref:n},c))}));function m(e,n){var t=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var i=t.length,r=new Array(i);r[0]=h;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o[u]="string"==typeof e?e:s,r[1]=o;for(var l=2;l<i;l++)r[l]=t[l];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},38413:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>r,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var a=t(87462),s=(t(67294),t(3905));const i={description:"Learn about the Snaps Keyring API."},r="Keyring API",o={unversionedId:"concepts/keyring-api",id:"concepts/keyring-api",title:"Keyring API",description:"Learn about the Snaps Keyring API.",source:"@site/snaps/concepts/keyring-api.md",sourceDirName:"concepts",slug:"/concepts/keyring-api",permalink:"/zs/keyring-doc/snaps/concepts/keyring-api",draft:!1,editUrl:"https://github.com/MetaMask/metamask-docs/edit/main/snaps/concepts/keyring-api.md",tags:[],version:"current",frontMatter:{description:"Learn about the Snaps Keyring API."},sidebar:"snapsSidebar",previous:{title:"Snaps design guidelines",permalink:"/zs/keyring-doc/snaps/concepts/design-guidelines"},next:{title:"Tutorials",permalink:"/zs/keyring-doc/snaps/tutorials"}},p={},l=[{value:"Terminology",id:"terminology",level:2},{value:"Components diagram",id:"components-diagram",level:2},{value:"Implementing a <code>Keyring</code> class",id:"implementing-a-keyring-class",level:2},{value:"Snap account creation flow",id:"snap-account-creation-flow",level:2},{value:"Synchronous signing flow",id:"synchronous-signing-flow",level:2},{value:"Asynchronous signing flow",id:"asynchronous-signing-flow",level:2}],c={toc:l},u="wrapper";function d(e){let{components:n,...i}=e;return(0,s.kt)(u,(0,a.Z)({},c,i,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"keyring-api"},"Keyring API"),(0,s.kt)("admonition",{type:"caution"},(0,s.kt)("p",{parentName:"admonition"},"This API is only available in MetaMask Flask, the canary distribution of MetaMask.")),(0,s.kt)("p",null,"The Keyring API brings deeper integration for custom EVM accounts inside MetaMask. Before the Keyring API, custom EVM accounts such MPC accounts, etc. needed to be shown separately, in a companion Dapp. Now these custom accounts can live alongside regular MetaMask accounts in the UI. Dapps can connect to them using ",(0,s.kt)("inlineCode",{parentName:"p"},"eth_requestAccounts"),", and seamlessly interact with them using ",(0,s.kt)("inlineCode",{parentName:"p"},"eth_sendTransaction"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"personal_sign"),", etc."),(0,s.kt)("p",null,"Using the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/concepts/keyring-api"},"Snaps Keyring API"),", you can integrate custom EVM accounts directly in MetaMask. These accounts will be displayed alongside MetaMask-controlled accounts in the UI:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Keyring snap accounts in Metamask UI",src:t(66719).Z,width:"702",height:"1192"})),(0,s.kt)("p",null,"Creating a keyring snap allows Dapps to connect to its accounts and submit requests like ",(0,s.kt)("inlineCode",{parentName:"p"},"personal_sign"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"eth_sendTransaction"),", etc. as if these were regular, MetaMask-controlled accounts."),(0,s.kt)("h2",{id:"terminology"},"Terminology"),(0,s.kt)("p",null,"Let's introduce some terminology used across the Keyring API:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Blockchain account"),": An object in a single blockchain, representing an account, with its balance, nonce, etc."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Request"),": A request sent by a Dapp to MetaMask."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Keyring account"),": An account model that represents one or more blockchain accounts."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Keyring snap"),": A snap that implements the Keyring API."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Keyring request"),": A request from MetaMask to a keyring snap, to perform an action on or using a keyring account. It wraps the original request sent by the Dapp and adds some metadata to it.")),(0,s.kt)("h2",{id:"components-diagram"},"Components diagram"),(0,s.kt)("p",null,"When interacting with accounts managed by a Keyring snap, we will encounter the following components:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Keyring snap component diagram",src:t(65521).Z,width:"500",height:"398"})),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"User"),": The web3 user interacting with the snap, the Dapp, and MetaMask."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Dapp"),": The web3 application that is requesting an action to be performed on an account."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"MetaMask"),": The web3 provider that dApps connect to. It routes requests to the keyring snaps and lets the user perform some level of account management."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Snap"),": A snap that implements the Keyring API to manage the user's accounts, and to handle requests that use these accounts."),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("strong",{parentName:"li"},"Snap UI"),": The snap's UI component that allows the user to interact with the snap to perform custom operations on accounts and requests.")),(0,s.kt)("h2",{id:"implementing-a-keyring-class"},"Implementing a ",(0,s.kt)("inlineCode",{parentName:"h2"},"Keyring")," class"),(0,s.kt)("p",null,"The first step for creating a Keyring snap is to implement the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/keyring-api/Type%20Aliases/type-alias.Keyring"},(0,s.kt)("inlineCode",{parentName:"a"},"Keyring")," interface"),". This interface describes all the methods necessary to make your custom EVM accounts work inside MetaMask with your own logic. The next sections will go over the methods of the ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," interface by describing the different flows that it handles."),(0,s.kt)("h2",{id:"snap-account-creation-flow"},"Snap account creation flow"),(0,s.kt)("p",null,"The first interaction between users and your Keyring snap will be the snap account creation process. Here is a diagram of the process:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Keyring snap account creation flow",src:t(36749).Z,width:"871",height:"695"})),(0,s.kt)("p",null,'The MetaMask account selection modal has an option called "Add snap account":'),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"add snap account option",src:t(19848).Z,width:"682",height:"1058"})),(0,s.kt)("p",null,"This option will show a list of keyring snaps, but will ultimately redirect the user to the companion Dapp for your Keyring snap. That is, a Dapp that contains all the UI to configure and manage the Keyring snap."),(0,s.kt)("p",null,"On that Dapp, you'll present a custom user interface allowing the user configure their custom EVM account. The Dapp will make use of the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/keyring-api/Classes/class.KeyringSnapRpcClient#createaccount"},(0,s.kt)("inlineCode",{parentName:"a"},"KeyringSnapRpcClient"),"'s ",(0,s.kt)("inlineCode",{parentName:"a"},"createAccount")," method"),", which will call your ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," class' method of the same name. An example of this can be found in the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/MetaMask/snap-simple-keyring/blob/d3f7f0156c59059c995fea87f90a3d0ad3a4c135/packages/site/src/pages/index.tsx#L136"},"Simple keyring snap companion Dapp"),"."),(0,s.kt)("p",null,"In your ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," class' ",(0,s.kt)("inlineCode",{parentName:"p"},"createAccount")," method, your responsibility is to create the account based on the parameters that were passed to you. Your snap has to keep track of the accounts that it creates, which can be done using ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/rpc-api#snap_managestate"},(0,s.kt)("inlineCode",{parentName:"a"},"snap_manageState")),". Once your snap has created an account, it should notify MetaMask using the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/rpc-api#createaccount"},(0,s.kt)("inlineCode",{parentName:"a"},"snap_manageAccounts")," ",(0,s.kt)("inlineCode",{parentName:"a"},"createAccount")," method"),". An example of this process can be found in the ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/MetaMask/snap-simple-keyring/blob/d3f7f0156c59059c995fea87f90a3d0ad3a4c135/packages/snap/src/keyring.ts#L61"},"Simple keyring snap code"),"."),(0,s.kt)("p",null,"Once your snap has created an account, that account can be used to sign messages and transactions. In the following sections we'll look at how this can be done."),(0,s.kt)("h2",{id:"synchronous-signing-flow"},"Synchronous signing flow"),(0,s.kt)("p",null,"Your Keyring snap will implement the simple flow if it's able to sign transactions directly. This would be the case if the snap doesn't need a third-party such as a hardware key or a second account's signature, as would be the case for a threshold signature scheme. The flow would look like this:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Synchronous signing flow",src:t(24991).Z,width:"2044",height:"1260"})),(0,s.kt)("p",null,"For a full example of a simple keyring snap, see ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/MetaMask/snap-simple-keyring"},(0,s.kt)("inlineCode",{parentName:"a"},"snap-simple-keyring")," on GitHub"),"."),(0,s.kt)("p",null,"The flow starts when a Dapp calls a method such as ",(0,s.kt)("inlineCode",{parentName:"p"},"personal_sign")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"eth_signTransaction"),", or when the user initiates a new funds transfer from the MetaMask UI. At that point, MetaMask will detect that this interaction is requested for an account controlled by your Keyring snap."),(0,s.kt)("p",null,"After the user approves the transaction in the UI, MetaMask will call the ",(0,s.kt)("inlineCode",{parentName:"p"},"submitRequest")," method of your ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," class. ",(0,s.kt)("inlineCode",{parentName:"p"},"submitRequest")," will receive the original RPC request, and will need to return a ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/keyring-api/Variables/variable.SubmitRequestResponseStruct"},(0,s.kt)("inlineCode",{parentName:"a"},"SubmitRequestResponse"))," with ",(0,s.kt)("inlineCode",{parentName:"p"},"pending")," set to ",(0,s.kt)("inlineCode",{parentName:"p"},"false"),", and ",(0,s.kt)("inlineCode",{parentName:"p"},"result")," set to the requested signature."),(0,s.kt)("admonition",{type:"caution"},(0,s.kt)("p",{parentName:"admonition"},"If your Keyring snap receives an ",(0,s.kt)("inlineCode",{parentName:"p"},"eth_sendTransaction")," request, you must treat it like an ",(0,s.kt)("inlineCode",{parentName:"p"},"eth_signTransaction")," request. That is, your snap is responsible for providing the signature in the response, and MetaMask is responsible for broadcasting the transaction.")),(0,s.kt)("h2",{id:"asynchronous-signing-flow"},"Asynchronous signing flow"),(0,s.kt)("p",null,"If your keyring snap implements a more complex scheme, e.g. threshold signing, then the flow will be more involved, and more ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," methods will be used. The diagram below will help you visualize the flow:"),(0,s.kt)("p",null,(0,s.kt)("img",{alt:"Asynchronous signing flow",src:t(153).Z,width:"1822",height:"1512"})),(0,s.kt)("p",null,"The flow starts the same way: a request to sign a transaction or arbitrary data is initiated by a Dapp or by the user. After approval, your snap's ",(0,s.kt)("inlineCode",{parentName:"p"},"submitRequest")," method is called."),(0,s.kt)("p",null,"Since your snap won't answer the request directly, it should store the pending request in its internal state using ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/rpc-api#snap_managestate"},(0,s.kt)("inlineCode",{parentName:"a"},"snap_manageState")),". This list of pending requests should be returned when the ",(0,s.kt)("inlineCode",{parentName:"p"},"listRequests")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"getRequest")," methods of your ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," class are called."),(0,s.kt)("p",null,'After storing the pending request, your snap should direct the user to a "companion Dapp" \u2013 a Dapp that serves as UI for the snap \u2013 where the rest of the flow can continue. Your snap can do this by creating a pop-up using ',(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/rpc-api#snap_dialog"},(0,s.kt)("inlineCode",{parentName:"a"},"snap_dialog"))," instructing the user to go to the companion Dapp's URL."),(0,s.kt)("p",null,"The Dapp will list your snap's pending requests using an RPC call facilitated by the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/keyring-api/Classes/class.KeyringSnapRpcClient#listrequests"},(0,s.kt)("inlineCode",{parentName:"a"},"KeyringSnapRpcClient"),"'s ",(0,s.kt)("inlineCode",{parentName:"a"},"listRequests")," method"),". The user can then act on those requests using whatever process applies to the snap."),(0,s.kt)("p",null,"Once the signing process is completed, the companion Dapp will resolve the request using the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/keyring-api/Classes/class.KeyringSnapRpcClient#approverequest"},(0,s.kt)("inlineCode",{parentName:"a"},"KeyringSnapRpcClient"),"'s ",(0,s.kt)("inlineCode",{parentName:"a"},"approveRequest")," method"),", which will call the snap's ",(0,s.kt)("inlineCode",{parentName:"p"},"Keyring")," method of the same name. This method receives the request's ID, as well as the final result."),(0,s.kt)("p",null,"When ",(0,s.kt)("inlineCode",{parentName:"p"},"approveRequest")," gets called, it can resolve the pending request by using the ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/reference/rpc-api#submitresponse"},(0,s.kt)("inlineCode",{parentName:"a"},"snap_manageAccounts"),"' ",(0,s.kt)("inlineCode",{parentName:"a"},"submitResponse")," method"),"."),(0,s.kt)("p",null,"Find out more about ",(0,s.kt)("a",{parentName:"p",href:"/zs/keyring-doc/snaps/tutorials/integrate-custom-evm-accounts"},"how to implement custom EVM accounts using the Keyring API"),"."))}d.isMDXComponent=!0},66719:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/accounts-ui-29c7215b3e30bc82c5674bf26d64b29c.png"},19848:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/add-snap-account-a0b0b4854e79cd62fa300b40e9e2f9ca.png"},153:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/asynchronous-flow-b1f803e0e7329c394f17910c67b9350d.png"},65521:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/components-diagram-fe20de86d108f422853c9c00649d3f10.png"},36749:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/create-account-flow-425c4feb8388212d3a55b843a40e5146.png"},24991:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/synchronous-flow-86d162f98ddac87d1fcfd21fed2d161d.png"}}]);