<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-snaps docs-doc-id-concepts/security-guidelines" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Snaps security guidelines | MetaMask developer documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.metamask.io/snaps-security-best-practices/snaps/concepts/security-guidelines/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-snaps-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-snaps-current"><meta data-rh="true" property="og:title" content="Snaps security guidelines | MetaMask developer documentation"><meta data-rh="true" name="description" content="Learn about best practices for secure and reliable Snaps."><meta data-rh="true" property="og:description" content="Learn about best practices for secure and reliable Snaps."><link data-rh="true" rel="icon" href="/snaps-security-best-practices/img/metamask-fox.svg"><link data-rh="true" rel="canonical" href="https://docs.metamask.io/snaps-security-best-practices/snaps/concepts/security-guidelines/"><link data-rh="true" rel="alternate" href="https://docs.metamask.io/snaps-security-best-practices/snaps/concepts/security-guidelines/" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.metamask.io/snaps-security-best-practices/snaps/concepts/security-guidelines/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://AWX4QVM59R-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="MetaMask developer documentation" href="/snaps-security-best-practices/opensearch.xml">




<script src="https://cmp.osano.com/AzZMxHTbQDOQD8c1J/a2e89f0e-f467-4542-bfea-30ea2c1a6648/osano.js"></script>
<script src="https://plausible.io/js/script.js" defer="defer" data-domain="docs.metamask.io"></script>
<script src="/js/feedback-script.js" defer="defer" async></script>
<script src="/js/getfeedback.js" defer="defer" async></script><link rel="stylesheet" href="/snaps-security-best-practices/assets/css/styles.f8b0abcf.css">
<link rel="preload" href="/snaps-security-best-practices/assets/js/runtime~main.c8c4f757.js" as="script">
<link rel="preload" href="/snaps-security-best-practices/assets/js/main.0e00ced2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/snaps-security-best-practices/"><div class="navbar__logo"><img src="/snaps-security-best-practices/img/metamask-logo.svg" alt="MetaMask logo" class="themedImage_ToTc themedImage--light_HNdA" width="150"><img src="/snaps-security-best-practices/img/metamask-logo-dark.svg" alt="MetaMask logo" class="themedImage_ToTc themedImage--dark_i4oU" width="150"></div><b class="navbar__title text--truncate"> │ ‎ Documentation</b></a><a class="navbar__item navbar__link" href="/snaps-security-best-practices/wallet/">Wallet</a><a class="navbar__item navbar__link" href="/snaps-security-best-practices/wallet/how-to/connect/set-up-sdk/">SDK</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/snaps-security-best-practices/snaps/">Snaps</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/snaps-security-best-practices/snaps/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/snaps-security-best-practices/snaps/get-started/">Get started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Get started&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/get-started/install-flask/">Install MetaMask Flask</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/get-started/quickstart/">Snaps quickstart</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/snaps-security-best-practices/snaps/how-to/">How to</a><button aria-label="Toggle the collapsible sidebar category &#x27;How to&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/snaps-security-best-practices/snaps/concepts/">Concepts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Concepts&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/anatomy/">Snaps anatomy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/lifecycle/">Snaps lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/user-interface/">Snaps user interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/execution-environment/">Snaps execution environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/design-guidelines/">Snaps design guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/security-guidelines/">Snaps security guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item flaskOnly_MY7u"><a class="menu__link" tabindex="0" href="/snaps-security-best-practices/snaps/concepts/keyring-api/">About the Keyring API</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/snaps-security-best-practices/snaps/tutorials/">Tutorials</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorials&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/snaps-security-best-practices/snaps/reference/">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Snaps security guidelines</h1><p>This page presents essential security principles for builders to develop new Snaps for the MetaMask wallet that are secure and reliable. These guidelines, derived from early Snaps audits, serve as a dynamic handbook, updated as new security-related concepts emerge in the context of Snaps development. Utilize these principles when creating your Snap to ensure it will be safe for users.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="permissions">Permissions<a href="#permissions" class="hash-link" aria-label="Direct link to Permissions" title="Direct link to Permissions">​</a></h2><p><em>Guidelines related to the Snap <a href="/snaps-security-best-practices/snaps/concepts/anatomy/#manifest-file">manifest file</a> and its <a href="/snaps-security-best-practices/snaps/reference/permissions/">permissions</a>.</em></p><ul><li><strong>Minimum Permissions:</strong> Remember to always follow the principle of &quot;least authority.&quot; When requesting or adding permissions in the Snap manifest, make sure to only add the minimum permissions needed by your Snap. Before publishing your Snap, check the permissions again and remove any unused permissions. You can validate your permissions using the <a href="https://metamask.github.io/snaps/snaps-simulator/staging/#/manifest" target="_blank" rel="noopener noreferrer">Snaps Simulator Manifest Validator</a>.</li><li><strong>Minimum RPC access:</strong> When adding the <a href="/snaps-security-best-practices/snaps/reference/permissions/#endowmentrpc"><code>endowment:rpc</code></a> permission for Snaps or dapps, ask yourself if both are really necessary. For example, if permission is granted to communicate with Snaps, it means other Snaps will be able to call your Snap&#x27;s sensitive RPC methods. </li><li><strong>Minimum network access:</strong> Only add the <a href="/snaps-security-best-practices/snaps/reference/permissions/#endowmentnetwork-access"><code>endowment:network-access</code></a> permission if it&#x27;s absolutely necessary, such as when needing to communicate with a remote API that is part of your Snap&#x27;s functionality. This is because users are rightly concerned about how much of their wallet usage is shared with remote servers. If this permission is needed, inform the user before communicating with remote servers and include a privacy policy in your Snap that explains how data is shared.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="transactions">Transactions<a href="#transactions" class="hash-link" aria-label="Direct link to Transactions" title="Direct link to Transactions">​</a></h2><p><em>Guidelines related to transactions and transaction signing.</em></p><ul><li><strong>Transaction Details</strong>: When handling transactions, always present the user with a meaningful prompt displaying all transaction details such as the receiver address, chain ID, network, and amount. Always show the &quot;origin&quot; domain name and &quot;network&quot; to provide the user with a clear context of where the transaction will be used or broadcasted. The user should be aware of the website that originated the transaction request and the blockchain it will be sent to. The receiver address is also crucial to prevent the user from sending funds to the wrong destination.</li><li><strong>Transparent Signing</strong>: Always display the message to be signed by the user in the Snap confirmation flow. Do not rely on the requesting website for this, as it could choose not to display it and let the Snap silently sign the message.</li><li><strong>Consentful Confirmations</strong>: Before signing a transaction, always show the user a confirmation prompt with all the transaction details as mentioned above.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="authorization">Authorization<a href="#authorization" class="hash-link" aria-label="Direct link to Authorization" title="Direct link to Authorization">​</a></h2><p><em>Guidelines related to user notifications and authorizations.</em></p><ul><li><p><strong>Transparent State Changes</strong>: The snap should always notify the user about important state changes. The user is then prompted and can decide whether to proceed with a particular action or not.</p></li><li><p><strong>Consentful Network/Account Switching</strong>: When the snap switches the Network or the Account, ensure that the user authorizes that action so they are aware of the context switching.</p></li><li><p><strong>Ensure the User is in Control</strong>: When modifying or reading internal state, display a confirmation dialog to inform the user of the request and allow them to approve or reject the action.</p></li><li><p><strong>Consentful Transaction Signing</strong>: Every time a transaction is about to be signed, prompt the user with the transaction details and provide an option to accept or reject the signature. If your Snap is designed to allow automatic transactions, prompt the user before enabling this and make sure they are aware of how it will work. You should also give the user a way to disable it. </p></li><li><p><strong>Consentful Account Management</strong>: When deriving or generating keypairs, accounts, or smart contracts, inform the user and ask for their consent.</p></li><li><p><strong>Protect User Keys</strong>: Do not allow the Snap to return all the user wallet addresses to the dapp, even public keys. As per MetaMask behavior, only authorized/connected addresses are exposed to the dapp. Users should have the opportunity to choose/authorize only the address(es) they want to expose.</p></li><li><p><strong>Limit Access to Sensitive Methods</strong>: If you are building a Snap that has sensitive RPC methods, you probably want to have a dedicated dapp that is used as an &quot;admin interface&quot; to interact with your Snap&#x27;s sensitive methods. There are two ways to do this: </p><ol><li><p>You can restrict the <code>endowment:rpc</code> permission to specific URLs using the <code>allowedOrigins</code> caveat: </p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">&quot;initialPermissions&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">&quot;endowment:rpc&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">&quot;allowedOrigins&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;metamask.io&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;consensys.io&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this example, the RPC methods will only be callable by dapps hosted at <code>https://metamask.io</code> or <code>https://consensys.io</code> (and any subdomains). Calls from any other website, or any Snap, will be rejected.</p></li><li><p>You can filter specific methods to specific URLs using the built-in <a href="https://developer.mozilla.org/en-US/docs/Web/API/URL" target="_blank" rel="noopener noreferrer">URL library</a>: </p><div class="language-JavaScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JavaScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">const referrer = new URL(origin);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if(referrer.protocol === &quot;https:&quot; &amp;&amp; referrer.host.endsWith(&quot;metamask.io&quot;)) { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  console.log(&quot;URL is valid&quot;); </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">else { </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  console.log(&quot;URL is NOT valid&quot;); </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this example, the RPC method can be restricted when the origin matches <code>https://metamask.io</code> or any subdomain. This check can be used on any RPC method that should not be callable by all websites.</p><p><strong>Note</strong>: you should avoid using regular expressions or string matching to filter URLs. The URL library provides a much more reliable interface for matching URLs. </p></li></ol></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="responsible-information-management">Responsible Information Management<a href="#responsible-information-management" class="hash-link" aria-label="Direct link to Responsible Information Management" title="Direct link to Responsible Information Management">​</a></h2><p><em>Guidelines related to handling sensitive data in a Snap.</em></p><ul><li><strong>Logging:</strong> Remove all logs to the JavaScript console that contain sensitive information, such as private keys. Furthermore, you should disable all logging before publishing your Snap.</li><li><strong>Beware of Errors:</strong> Be cautious about potential errors/exceptions that could write sensitive information to the console. Review parts of your code where errors/exceptions could be raised. In these cases, error stacks could be written to the console with sensitive information (e.g., a private key). This information could then be captured in data logs, or the user could be phished into copying that console error to be sent to a malicious actor.</li><li><strong>Keep Private Keys Private:</strong> Avoid retrieving the user&#x27;s private key from the Snap unless absolutely necessary, such as to sign a transaction. If all you need is the user&#x27;s public key, request it with the method: <code>snap_getBip32PublicKey</code>, instead of deriving it from the private key. Never return the private key in an RPC method to a dapp or another Snap. If you want to give users a way to view their private key, you should display it in a dialog rather than exposing it to a dapp.</li><li><strong>Limit Exposure:</strong> Avoid accidentally returning sensitive data from a method. In some cases, a developer may have a method that is supposed to return sensitive data only in specific cases, but due to a typo or bad logic, they end up returning the sensitive data incorrectly, causing potential data leaks. Even if a snap has a legitimate reason for allowing a user to export sensitive data such as a password or private key, the developer should still take extra measures to prevent that information from being revealed carelessly (similar to how MetaMask makes it hard to reveal an SRP and hard for an observer looking over a user’s shoulder to see it). <em>When in doubt, choose friction over convenience for sensitive data.</em></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="input-validation">Input Validation<a href="#input-validation" class="hash-link" aria-label="Direct link to Input Validation" title="Direct link to Input Validation">​</a></h2><p><em>Validating RPC parameters and handling values.</em></p><ul><li><p><strong>User Input Validation</strong>: Always validate and sanitize user inputs coming into the Snap-exposed RPC methods. Be vigilant about validation. Never assume that a parameter is safe to use. If not, and those values are used inside the logic of your Snap methods, a dapp or a user can exploit that logic in an unsafe way.</p></li><li><p><strong>Obtain Values from MetaMask</strong>: Always obtain values such as chainId or address from MetaMask instead of the dapp. This is because a dapp could display incorrect values, or a malicious one could phish the user by showing different values with the intention of tricking them into performing actions they wouldn&#x27;t want to do (for example, signing a transaction for a network they didn&#x27;t intend to broadcast the transaction to). Furthermore, if the dapp is providing values that do not match the values from MetaMask, you should warn the user in your confirmation flow.</p></li><li><p><strong>Use <code>copyable</code> for Safe Disclosures</strong>: When displaying arbitrary content, use <a href="/snaps-security-best-practices/snaps/how-to/use-custom-ui/#copyable"><code>copyable</code></a> instead of <code>text</code>. A common use case for a snap dialog is to show a confirmation with some arbitrary content, such as for signing a message. One common pitfall when using dialogs is that the input may contain special characters that will render as Markdown and could mislead the user. For example: </p><p><img loading="lazy" alt="Example not using copyable with Markdown rendering" src="/snaps-security-best-practices/assets/images/copyable-example-1-8827b8ed8f605cd1ef68eed917b64325.png" width="2000" height="930" class="img_ev3q"></p><p>The problem is that these special characters: <!-- -->*<!-- --> and <!-- -->_<!-- --> may render Markdown formatting and thus what the user sees will not match the content. To avoid this, use <code>copyable</code> instead:</p><p><img loading="lazy" alt="Example using copyable with clean rendering" src="/snaps-security-best-practices/assets/images/copyable-example-2-e9bfd44f9fb470673ee306400785317e.png" width="2000" height="930" class="img_ev3q"></p><p> <code>copyable</code> does not render Markdown and has the added benefit that the user can click to copy the content. Also, the formatting provides a visual delineator to separate arbitrary input or fields from user interface text.</p></li><li><p><strong>Transaction Data Size Check</strong>: Always check the size of a transaction data&#x27;s function arguments. The encoded transaction data includes the function signature and its arguments. The ABI specification requires that all arguments, regardless of their types, must be 32 bytes in size. If an argument does not have 32 bytes in an ABI-encoded transaction data, the calling contract may behave differently depending on the contract compiler version. For instance, Solidity 0.5.0 treats these non-aligned arguments as invalid and reverts the function call. However, versions before Solidity 0.5.0 automatically append zeros at the end of the transaction data to ensure all arguments are 32-byte sized. An attacker could exploit this feature to bypass any security checks implemented in the corresponding contract function that reads those function arguments.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-deprecated-apis-or-methods">Using Deprecated APIs or Methods<a href="#using-deprecated-apis-or-methods" class="hash-link" aria-label="Direct link to Using Deprecated APIs or Methods" title="Direct link to Using Deprecated APIs or Methods">​</a></h2><p><em>List of deprecated methods to avoid.</em></p><ul><li>Don’t use <code>wallet_enable</code> or <code>wallet_invokeSnap</code> which was deprecated in favour of <code>wallet_requestSnaps</code></li><li>Don’t use <code>snap_confirm</code> which was deprecated in favour of <code>snap_dialog</code></li><li>Don’t use <code>snap_getBip44Entropy</code> with <code>coinType</code> 60 - this derivation path is reserved for MetaMask EOA accounts</li><li>Don’t use <code>endowment:long-running</code> which was deprecated for our stable release but was still allowed in Flask</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="coding-best-practices">Coding Best Practices<a href="#coding-best-practices" class="hash-link" aria-label="Direct link to Coding Best Practices" title="Direct link to Coding Best Practices">​</a></h2><p><em>Various coding security tips and warnings.</em></p><ul><li><strong>SES Compatibility</strong>: Always use packages or libraries that are compatible with SES (Hardened JavaScript). If not, you may encounter errors that require <a href="/snaps-security-best-practices/snaps/how-to/troubleshoot/#patch-dependencies">patching a specific dependency</a> to fix.</li><li><strong>Timers and Side-Channel Attacks</strong>: Certain JavaScript features like timers (e.g., <code>Date.now</code>) can expose critical system information, making a user vulnerable to <a href="https://www.rambus.com/blogs/side-channel-attacks/" target="_blank" rel="noopener noreferrer">side-channel attacks</a>. <em>In the Snaps execution environment, the precision of these timers has been reduced to prevent this.</em> </li><li><strong>Unsafe Cryptographic Libraries</strong>: Avoid using unsafe cryptographic libraries. <code>Math.random</code> is not sufficiently random for generating cryptographic hashes, which can expose a user to reverse engineering or brute-forcing keys in the future. Usage of <code>Math.random</code> is discouraged in Snaps for any critical random number generation. Insufficient hashing algorithms such as <code>md5</code> or <code>sha2</code> should also not be used. Use safe hashing algorithms such as <code>sha256</code>. Also, avoid using custom or unproven cryptography methods or libraries. <strong>Developers should never roll their own cryptography</strong> or use cryptographic methods that are insufficiently tested. Consider using <a href="/snaps-security-best-practices/snaps/reference/rpc-api/#snap_getentropy"><code>snap_getEntropy</code></a> for entropy and consider using the built-in <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API" target="_blank" rel="noopener noreferrer">Web Crypto API</a> or <a href="https://paulmillr.com/noble/" target="_blank" rel="noopener noreferrer">Noble cryptography libraries</a>. <em>When in doubt, choose audited, widely used libraries over obscure, untested implementations.</em></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dependency-management">Dependency Management<a href="#dependency-management" class="hash-link" aria-label="Direct link to Dependency Management" title="Direct link to Dependency Management">​</a></h2><p><em>Best practices for securing your supply chain.</em></p><ul><li><strong>Pin NPM Package Dependencies:</strong> Pin all NPM package dependencies in the Snap&#x27;s dependency tree to exact versions. If not done, a supply chain attack could be used to trick you into including a malicious version of that package instead of the original, legitimate one.</li><li><strong>Secure Your Stack:</strong> Your Snap&#x27;s companion dapp and any remote servers are part of your security model. Consider using <a href="https://github.com/LavaMoat/LavaMoat" target="_blank" rel="noopener noreferrer">LavaMoat</a> to secure relevant parts of your stack and follow security best practices for your website or server as well. </li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="publishing-and-serving">Publishing and Serving<a href="#publishing-and-serving" class="hash-link" aria-label="Direct link to Publishing and Serving" title="Direct link to Publishing and Serving">​</a></h2><p><em>Guidelines for making your Snap available to users safely.</em></p><ul><li><strong>Snap Updates</strong>: When serving a Snap from a particular website, make sure users are getting the latest version of your Snap. Do not allow any actions on that website before reconnecting it to MetaMask and loading a new or updated version of the Snap. This will prevent users from using outdated versions of the snap that may have potential bugs and security issues.</li><li><strong>Snap Publication</strong>: Ensure correct publication of the Snap. You only need to publish the <code>packages/snap</code> folder, not, for example, the entire GitHub repository for a project.</li><li><strong>Other Wallet Extensions</strong>: Be aware that if the user has other wallet extensions installed in the browser, a call to the MetaMask provider <code>window.ethereum</code> can be overridden by them. Instead of relying on <code>window.ethereum</code>, use EIP-6963 to access the MetaMask provider in a reliable way: <a href="https://github.com/MetaMask/snaps/discussions/2001" target="_blank" rel="noopener noreferrer">Connecting to Snaps with EIP-6963</a>. </li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-rules">General Rules<a href="#general-rules" class="hash-link" aria-label="Direct link to General Rules" title="Direct link to General Rules">​</a></h2><p>In general, when developing new Snaps, you should always put yourself in the user’s shoes and consider their perspective and how they use MetaMask. You should always prioritize their privacy and the security of their assets.</p><ul><li>Always inform the user about any action happening in the Snap through the Snap UI, especially for more sensitive actions. This allows the user to decide whether to proceed with a particular action or not. Avoid performing actions in the background, especially when dealing with Snap’s state, private keys, transaction signing, or a user&#x27;s Personally Identifiable Information (PII). For instance, a Snap RPC method that exports a user’s private key without any feedback to the user (and a way for them to deny it) is a bad practice. A threat actor could exploit this to phish the user into exposing their private key without their knowledge.</li><li>When signing transactions, always warn the user and display all details of the transaction in a clear and understandable format. This allows the user to decide whether to sign it or not and helps prevent scams related to wallet drainage.</li><li>Always display the “Origin” domain of the dapp that initiated an action in the Snap. This clarifies to the user which dapp is requesting a particular action in the Snap.</li><li>Protect user info and privacy by being careful about what you are sending to external servers. This includes user IPs, emails, and any PII that can uniquely identify the user. Include a privacy policy for maximum transparency.</li><li>Only manipulate a user’s private key if strictly necessary, and especially avoid doing so when dealing with keypairs already managed by MetaMask itself.</li><li>Always use the minimum necessary permissions. This ensures no unforeseen security issues will arise related to “unused” permissions.</li><li>Always keep your Snap source code updated with the latest npm packages and always &quot;pin&quot; specific versions for those packages. This prevents possible security bugs that may arise in outdated versions of packages/libraries and defends against supply chain attacks. <em>You can quickly check the status of your dependencies by running <code>npm audit</code> in your Snap directory.</em></li></ul><p><em>Have a security best practice not listed here? Share it in our <a href="https://github.com/MetaMask/snaps/discussions" target="_blank" rel="noopener noreferrer">discussion board</a>.</em></p></div><div class="getfeedback-container"><div ub-in-page="65299f6ab62d7120574ba82a"></div><div ub-in-page="6529a08f7a6d62001f19a79d"></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/MetaMask/metamask-docs/edit/main/snaps/concepts/security-guidelines.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/snaps-security-best-practices/snaps/concepts/design-guidelines/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Snaps design guidelines</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/snaps-security-best-practices/snaps/concepts/keyring-api/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">About the Keyring API</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#permissions" class="table-of-contents__link toc-highlight">Permissions</a></li><li><a href="#transactions" class="table-of-contents__link toc-highlight">Transactions</a></li><li><a href="#authorization" class="table-of-contents__link toc-highlight">Authorization</a></li><li><a href="#responsible-information-management" class="table-of-contents__link toc-highlight">Responsible Information Management</a></li><li><a href="#input-validation" class="table-of-contents__link toc-highlight">Input Validation</a></li><li><a href="#using-deprecated-apis-or-methods" class="table-of-contents__link toc-highlight">Using Deprecated APIs or Methods</a></li><li><a href="#coding-best-practices" class="table-of-contents__link toc-highlight">Coding Best Practices</a></li><li><a href="#dependency-management" class="table-of-contents__link toc-highlight">Dependency Management</a></li><li><a href="#publishing-and-serving" class="table-of-contents__link toc-highlight">Publishing and Serving</a></li><li><a href="#general-rules" class="table-of-contents__link toc-highlight">General Rules</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/snaps-security-best-practices/">Home</a></li><li class="footer__item"><a class="footer__link-item" href="/snaps-security-best-practices/wallet/">MetaMask wallet</a></li><li class="footer__item"><a class="footer__link-item" href="/snaps-security-best-practices/sdk/">MetaMask SDK</a></li><li class="footer__item"><a class="footer__link-item" href="/snaps-security-best-practices/snaps/">Snaps</a></li></ul></div><div class="col footer__col"><div class="footer__title">GitHub</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/MetaMask/metamask-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/MetaMask/metamask-extension/" target="_blank" rel="noopener noreferrer" class="footer__link-item">MetaMask wallet GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/MetaMask/metamask-sdk/" target="_blank" rel="noopener noreferrer" class="footer__link-item">MetaMask SDK GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/MetaMask/snaps-monorepo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Snaps GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/consensys" target="_blank" rel="noopener noreferrer" class="footer__link-item">Consensys Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/MetaMask/metamask-extension/blob/develop/docs/README.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contribute to MetaMask<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/MetaMask/metamask-docs/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contribute to the docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://consensys.net/privacy-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://consensys.net/terms-of-use/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://metamask.io/cla/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contributor License Agreement<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><button id="manage-cookie-btn">Manage cookies</button></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://metamask.io/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/snaps-security-best-practices/img/metamask-logo.svg" alt="MetaMask logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo" width="250"><img src="/snaps-security-best-practices/img/metamask-logo-dark.svg" alt="MetaMask logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo" width="250"></a></div><div class="footer__copyright">© 2023 MetaMask • A Consensys Formation</div></div></div></footer></div>
<script src="/snaps-security-best-practices/assets/js/runtime~main.c8c4f757.js"></script>
<script src="/snaps-security-best-practices/assets/js/main.0e00ced2.js"></script>
</body>
</html>